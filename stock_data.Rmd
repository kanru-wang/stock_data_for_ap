---
title: "stock_data"
output: html_notebook
---

```{r}
#install.packages("fst")
library(fst)
library(ggplot2)
library(data.table)
library(magrittr)
library(tidyverse)
library(readr)
```

```{r}
monthly_world_val = fst("C:/Users/wangka3/Desktop/learning/R_exercise/monthly_world_val.fst")
daily_US_prices = fst("C:/Users/wangka3/Desktop/learning/R_exercise/daily_US_prices.fst")
```

# Enterprise Value to Sales

* Calculate each company's yearly median enterprise value to sales ratio, displayed as a point.
* Divide companies into two groups: U.S. and the rest of the world.
* Display by sector, by year.
* Each line represents the median of companies' yearly median enterprise value to sales ratio.
* Zoomed to y axis range (-1, 40), but points outside the graph and in range (-5, 2000) are all used to calculate the positions of lines.  

```{r}
EVTS_RAW = data.table(
  DATE = monthly_world_val[['DATE']],
  TICKER = monthly_world_val[['TICKER']],
  COUNTRY = monthly_world_val[['COUNTRY']],
  SECTOR = monthly_world_val[['SECTOR']],
  EV = monthly_world_val[['EV']],
  SALES = monthly_world_val[['SALES']]
)
```

```{r}
EVTS = EVTS_RAW %>%
  mutate(EVTS = EV/SALES,
         US_vs_Others = ifelse(.$COUNTRY == "United States", "U.S.", "Others"),
         YEAR = format(as.Date(.$DATE, format="%Y-%m-%d"),"%Y")) %>%
  select(TICKER, US_vs_Others, SECTOR, YEAR, EVTS) %>%
  filter(!is.na(SECTOR)) %>%  # Exclude na
  filter(SECTOR != "EXCLUDE") %>%  # Exclude "EXCLUDE"
  group_by(TICKER, US_vs_Others, SECTOR, YEAR) %>% 
  summarize(ticker_yearly_median_EVTS = median(EVTS)) %>% 
  filter(ticker_yearly_median_EVTS > - 5,  # Exclude extreme values
         ticker_yearly_median_EVTS < 2000)

#quantile(EVTS$ticker_yearly_median_EVTS, c(0.005, 0.01, 0.99, 0.995), na.rm = TRUE)
```

* US companies' enterprise value to sales ratios seem to be usually higher.
* Year 2000 Internet Bubble can be seen.
* Some sectors have much higher enterprise value to sales ratios.

```{r fig1, fig.height = 30, fig.width = 14}
ggplot(EVTS, aes(x = YEAR, y = ticker_yearly_median_EVTS,
                 colour = factor(US_vs_Others),
                 group = factor(US_vs_Others))) +
  geom_point(alpha = 0.2) +
  stat_summary(aes(y = ticker_yearly_median_EVTS), 
               fun.y = median, geom = "line", size = 1.5, alpha = 0.7) +
  coord_cartesian(ylim = c(-1, 40)) +  # Zoom in  
  facet_wrap( ~ SECTOR, ncol = 3) +
  theme(axis.text.x = element_text(angle = 90, size = 10),
        legend.position="top") +
  ggtitle("Yearly EVTS by sector, US vs. the rest of the world") 
```


# Create a daily total return price index for the largest 500 stocks (at each point in time) listed on the US market 
```{r}
INDEX_RAW = data.table(
  DATE = daily_US_prices[['DATE']],
  MARKET_CAP = daily_US_prices[['MARKET_CAP']],
  TICKER = daily_US_prices[['TICKER']],
  PRICE =  daily_US_prices[['PRICE']]
)
```

### Option 1: creating an index without including dividends, i.e. sum(market cap for top 500 companies)
```{r}
INDEX_1 = INDEX_RAW %>% 
  group_by(DATE) %>% 
  top_n(n = 500, wt = MARKET_CAP) %>% 
  summarize(sum_market_cap = sum(MARKET_CAP))

```

### Option 2: creating a Total Return index, i.e. sum(volume of issued stocks x adj price, for top 500 companies)

#### We need to get the volume of issued stocks when a ticker first appeared in the dataset

```{r}
ticker_first_appear = INDEX_RAW %>% 
  group_by(TICKER) %>% 
  summarize(DATE = min(DATE)) # first_appear_date
```

```{r}
number_of_stocks_beginning = 
  merge(x = ticker_first_appear, y = INDEX_RAW,
        by = c("TICKER", "DATE"), all.x = TRUE) %>% 
  mutate(number_of_stocks = MARKET_CAP / PRICE) %>% 
  select(TICKER, number_of_stocks)
```

#### Daily largest 500 stocks are still determined by Market Cap

```{r}
INDEX_2 = merge(x = INDEX_RAW, y = number_of_stocks_beginning,
                by = "TICKER", all.x = TRUE) %>% 
  mutate(market_cap_plus_dividends = PRICE * number_of_stocks) %>% 
  group_by(DATE) %>% 
  top_n(n = 500, wt = MARKET_CAP) %>% 
  summarize(sum_market_cap_plus_dividends = sum(market_cap_plus_dividends))
```

#### Import S&P 500 Total Return Index downloaded from Yahoo Finance
```{r}
SP500TR <- read_csv("C:/Users/wangka3/Desktop/learning/R_exercise/SP500TR.csv", 
    col_types = cols(Date = col_date(format = "%d/%m/%Y")))
```

#### Apply index divisor to our index in order to align our index with S&P 500 Total Return
```{r}
index_divisor_1 = INDEX_1$sum_market_cap[1] / SP500TR$`Adj Close`[1]
INDEX_1_aligned_with_SP500TR = INDEX_1 %>% mutate(index = sum_market_cap / index_divisor_1)
```

```{r}
index_divisor_2 = INDEX_2$sum_market_cap_plus_dividends[1] / SP500TR$`Adj Close`[1]
INDEX_2_aligned_with_SP500TR = INDEX_2 %>% 
  mutate(index = sum_market_cap_plus_dividends / index_divisor_2)
```

#### Plot
```{r}
ggplot() + 
  geom_line(data = INDEX_1_aligned_with_SP500TR, 
            aes(x = DATE, y = index), color = "red") +
  geom_line(data = INDEX_2_aligned_with_SP500TR, 
            aes(x = DATE, y = index), color = "blue") +
  geom_line(data = SP500TR, 
            aes(x = Date, y = `Adj Close`), color = "purple") +
  xlab('Date') +
  ylab('Index') +
  ggtitle(" Red line represents Option 1.\n Blue line represents Option 2.\n Purple line represents S&P 500 TR.") 
```
